<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Device</title>
    <style>
        table {
            border-collapse: collapse;
            width: 60%;
            margin: 20px auto;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
        }

        th {
            background: #f2f2f2;
        }
    </style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(initChart);


        let data, chart, options;
        let x = 0; // time or sample index


        function initChart() {
            data = new google.visualization.DataTable();
            data.addColumn('datetime', 'Time');
            data.addColumn('number', 'Value');
            data.addColumn({ type: 'string', role: 'tooltip' });


            options = {
                title: 'Live Data',
                curveType: 'function',
                legend: { position: 'none' },
                width: 600,
                height: 400,
                pointSize: 5
            };


            chart = new google.visualization.LineChart(document.getElementById('chart_div'));


            // radi poll svake sekunde (1000ms)
            setInterval(pollData, 1000);
        }


        function pollData() {
            fetch('/dogadjaji?device_id=<%= device.device_id %>')
                .then(r => r.json())
                .then(arr => {
                    data.removeRows(0, data.getNumberOfRows()); // obrisi prethodno

                    arr.forEach(item => {
                        const time = new Date(item.timestamp);
                        const tooltipText = item.tip;

                        data.addRow([time, Number(item.vrednost), tooltipText]);
                    });
                    while (data.getNumberOfRows() > 20) {
                        data.removeRow(0); // zadrzi samo poslednjih 20 uzoraka, bez obzira koliko je uzoraka dobijeno u odgovoru
                    }
                    chart.draw(data, options);
                });
        }
    </script>
</head>

<body>
    <h2 style="text-align:center">Uredjaj</h2>
    <p>
        ID: <%= device._id %><br>
        Naziv: <%= device.ime %><br>
        Naziv: <%= device.mesto %><br>
        DeviceID: <%= device.device_id %><br>
    </p>
    <h3 style="text-align:center">Registrovani dogadjaji/poruke uredjaja</h3>
    <div id="chart_div"></div>
    <a href="/uredjaji">Nazad</a>
</body>

</html>