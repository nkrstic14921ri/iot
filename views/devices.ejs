<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Device</title>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        table {
            border-collapse: collapse;
            width: 60%;
            margin: 20px auto;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
        }

        th {
            background: #f2f2f2;
        }

        #map {
            height: 50vh;
            width: 30vw;
        }
    </style>
     <script>
        function deleteDevice(dev_id) {            
            console.log('device id ' + dev_id)
            fetch(`/uredjaj?device_id=${dev_id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    console.log(`Device ${dev_id} deleted successfully.`);
                } else {
                    console.error('Failed to delete device');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</head>

<body>
    <h2 style="text-align:center">Uredjaji</h2>
    <div style="width: 80%; display: flex;  justify-content: flex-end; gap: 10px">
    <a href="unos-uredjaja.html" class="btn btn-success">Unesi novi ureÄ‘aj</a>
    <a href="logout" class="btn btn-danger">Logout</a>
    </div>
    <table class="table table-primary" style="width: 60%">
        <!-- Header tabele -->
        <tr class="table-primary">
            <th class="table-primary">ID</th>
            <th class="table-primary">Ime</th>
            <th class="table-primary">Mesto</th>
            <th class="table-primary">Opis</th>
            <th class="table-primary">Device ID</th>
            <th class="table-primary"></th>
            <th class="table-primary"></th>
        </tr>
        <!-- Lista uredjaja -->
        <% devices.forEach(d=> { %>
            <tr class="table-primary">
                <td class="table-primary">
                    <%= d._id %>
                </td>
                <td class="table-primary">
                    <%= d.ime %>
                </td class="table-primary">
                <td class="table-primary">
                    <%= d.mesto %>
                </td class="table-primary">
                <td class="table-primary">
                    <%= d.opis %>
                </td class="table-primary">
                <td class="table-primary">
                    <%= d.device_id %>
                </td class="table-primary">
                <td class="table-primary">
                    <a href="/uredjaj?device_id=<%= d.device_id %>" class="btn btn-primary">
                        Show details
                    </a>
                </td>
                <td class="table-primary">
                    <button onclick="deleteDevice('<%= d.device_id %>')" class="btn btn-danger">Delete</button>
                </td>
            </tr>
            <% }) %>
    </table>
    <h2 style="text-align:center">Lokacije uredjaja</h2>
    <div id="map" style="left: 35%;"></div>

    <script>
        const map = L.map('map').setView([44.815313, 20.459812], 18);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var devices = <%- JSON.stringify(devices) %>
        devices.forEach(d => {
            L.marker([d.lat, d.lon]).addTo(map)
            .bindPopup(d.ime)
            .openPopup()
        })
    </script>
</body>

</html>